<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FusionGAN Interactive Demo</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #888;
            font-size: 1.1rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .controls {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #00d4ff;
        }

        .control-group input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #00d4ff;
            border-radius: 50%;
            cursor: pointer;
        }

        .control-value {
            text-align: right;
            font-family: monospace;
            color: #7b2cbf;
        }

        select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1rem;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #00d4ff;
        }

        button {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .visualization {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: rgba(0, 212, 255, 0.2);
            border-color: #00d4ff;
            color: #00d4ff;
        }

        .tab:hover:not(.active) {
            border-color: rgba(255, 255, 255, 0.4);
            color: #e0e0e0;
        }

        .plot-container {
            height: 500px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #00d4ff;
        }

        .metric-label {
            color: #888;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .source-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .source-cps { background: #2ecc71; }
        .source-puf { background: #3498db; }
        .source-synth { background: #e74c3c; }

        .explanation {
            background: rgba(0, 212, 255, 0.1);
            border-left: 3px solid #00d4ff;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .architecture-diagram {
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 2rem;
            gap: 1rem;
        }

        .arch-box {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
        }

        .arch-noise { background: rgba(255, 255, 255, 0.1); }
        .arch-gen { background: rgba(123, 44, 191, 0.4); }
        .arch-synth { background: rgba(231, 76, 60, 0.4); }
        .arch-disc-cps { background: rgba(46, 204, 113, 0.4); }
        .arch-disc-puf { background: rgba(52, 152, 219, 0.4); }

        .arch-arrow {
            font-size: 1.5rem;
            color: #888;
        }

        .arch-proj {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Pseudo-random number generator with seed
        function seededRandom(seed) {
            let s = seed;
            return function() {
                s = Math.sin(s) * 10000;
                return s - Math.floor(s);
            };
        }

        // Box-Muller transform for normal distribution
        function normalRandom(rng) {
            const u1 = rng();
            const u2 = rng();
            return Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        }

        // Generate synthetic population
        function generatePopulation(n, correlation, seed = 42) {
            const rng = seededRandom(seed);
            const data = {
                age: [],
                wages: [],
                unemployment: [],
                capital_gains: [],
                dividends: []
            };

            for (let i = 0; i < n; i++) {
                const age = 20 + Math.floor(rng() * 60);
                const wages = Math.exp(10 + normalRandom(rng) * 0.8);
                const hasUI = rng() < 0.05;
                const unemployment = hasUI ? Math.exp(8 + normalRandom(rng) * 0.5) : 0;
                const capGainsBase = (age - 30) * correlation * 1000;
                const capital_gains = Math.max(0, capGainsBase + normalRandom(rng) * 8000);
                const dividends = Math.exp(7 + normalRandom(rng) * 1.2);

                data.age.push(age);
                data.wages.push(wages);
                data.unemployment.push(unemployment);
                data.capital_gains.push(capital_gains);
                data.dividends.push(dividends);
            }

            return data;
        }

        // Simple synthetic generator (mimics trained GAN)
        function generateSynthetic(n, epochs, weighting, seed = 123) {
            const rng = seededRandom(seed);
            const quality = Math.min(0.95, 0.3 + epochs / 300);
            const rareBoost = weighting === 'cluster' ? 1.5 : 1.0;

            const data = {
                age: [],
                wages: [],
                unemployment: [],
                capital_gains: [],
                dividends: []
            };

            for (let i = 0; i < n; i++) {
                // Age distribution with rare elderly boost
                let age;
                if (rng() < 0.1 * rareBoost && rng() < quality) {
                    age = 65 + Math.floor(rng() * 20);
                } else {
                    age = 20 + Math.floor(rng() * 50);
                }

                const wages = Math.exp(10 + normalRandom(rng) * 0.9);
                const hasUI = rng() < 0.05;
                const unemployment = hasUI ? Math.exp(8 + normalRandom(rng) * 0.6) : 0;

                // Cross-source correlation learning
                const corrQuality = quality * 0.85;
                const capGainsBase = (age - 30) * corrQuality * 1000;
                const capital_gains = Math.max(0, capGainsBase + normalRandom(rng) * 10000);
                const dividends = Math.exp(7 + normalRandom(rng) * 1.3);

                data.age.push(age);
                data.wages.push(wages);
                data.unemployment.push(unemployment);
                data.capital_gains.push(capital_gains);
                data.dividends.push(dividends);
            }

            return data;
        }

        // Calculate correlation
        function correlation(x, y) {
            const n = x.length;
            const meanX = x.reduce((a, b) => a + b, 0) / n;
            const meanY = y.reduce((a, b) => a + b, 0) / n;

            let num = 0, denX = 0, denY = 0;
            for (let i = 0; i < n; i++) {
                const dx = x[i] - meanX;
                const dy = y[i] - meanY;
                num += dx * dy;
                denX += dx * dx;
                denY += dy * dy;
            }

            return num / Math.sqrt(denX * denY);
        }

        // Calculate coverage (simplified)
        function calculateCoverage(real, synthetic, key) {
            // Sample-based approximation
            let totalDist = 0;
            const sample = real[key].slice(0, 100);

            for (const val of sample) {
                let minDist = Infinity;
                for (const synthVal of synthetic[key].slice(0, 200)) {
                    const dist = Math.abs(val - synthVal);
                    if (dist < minDist) minDist = dist;
                }
                totalDist += minDist;
            }

            return totalDist / sample.length;
        }

        function App() {
            const [nSamples, setNSamples] = useState(500);
            const [epochs, setEpochs] = useState(100);
            const [weighting, setWeighting] = useState('uniform');
            const [trueCorrelation, setTrueCorrelation] = useState(0.6);
            const [activeTab, setActiveTab] = useState('distributions');
            const [isTraining, setIsTraining] = useState(false);
            const [realData, setRealData] = useState(null);
            const [synthData, setSynthData] = useState(null);
            const plotRef = useRef(null);

            // Generate initial data
            useEffect(() => {
                const real = generatePopulation(nSamples, trueCorrelation);
                setRealData(real);
                runTraining(real);
            }, []);

            // Run "training" and generate synthetic data
            const runTraining = (real) => {
                setIsTraining(true);

                // Simulate training delay
                setTimeout(() => {
                    const synth = generateSynthetic(nSamples, epochs, weighting);
                    setSynthData(synth);
                    setIsTraining(false);
                }, 500);
            };

            // Update plots when data or tab changes
            useEffect(() => {
                if (!realData || !synthData || !plotRef.current) return;

                const layout = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0.2)',
                    font: { color: '#e0e0e0' },
                    showlegend: true,
                    legend: { x: 1, xanchor: 'right', y: 1 },
                    margin: { t: 40, r: 20, b: 50, l: 60 },
                    xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                    yaxis: { gridcolor: 'rgba(255,255,255,0.1)' }
                };

                let traces;

                if (activeTab === 'distributions') {
                    traces = [
                        {
                            x: realData.age,
                            type: 'histogram',
                            name: 'Real (CPS)',
                            marker: { color: 'rgba(46, 204, 113, 0.6)' },
                            nbinsx: 30
                        },
                        {
                            x: synthData.age,
                            type: 'histogram',
                            name: 'Synthetic',
                            marker: { color: 'rgba(231, 76, 60, 0.6)' },
                            nbinsx: 30
                        }
                    ];
                    layout.title = 'Age Distribution';
                    layout.xaxis.title = 'Age';
                    layout.yaxis.title = 'Count';
                    layout.barmode = 'overlay';

                } else if (activeTab === 'correlation') {
                    traces = [
                        {
                            x: realData.age,
                            y: realData.capital_gains,
                            mode: 'markers',
                            type: 'scatter',
                            name: 'True Relationship',
                            marker: { color: '#34495e', size: 5, opacity: 0.5 }
                        },
                        {
                            x: synthData.age,
                            y: synthData.capital_gains,
                            mode: 'markers',
                            type: 'scatter',
                            name: 'Synthetic',
                            marker: { color: '#e74c3c', size: 5, opacity: 0.5 }
                        }
                    ];
                    layout.title = 'Cross-Source Correlation: Age vs Capital Gains';
                    layout.xaxis.title = 'Age (CPS only)';
                    layout.yaxis.title = 'Capital Gains (PUF only)';

                } else if (activeTab === 'wages') {
                    traces = [
                        {
                            x: realData.wages.map(w => Math.log10(w)),
                            type: 'histogram',
                            name: 'Real',
                            marker: { color: 'rgba(46, 204, 113, 0.6)' },
                            nbinsx: 30
                        },
                        {
                            x: synthData.wages.map(w => Math.log10(w)),
                            type: 'histogram',
                            name: 'Synthetic',
                            marker: { color: 'rgba(231, 76, 60, 0.6)' },
                            nbinsx: 30
                        }
                    ];
                    layout.title = 'Wages Distribution (Log Scale)';
                    layout.xaxis.title = 'Log10(Wages)';
                    layout.yaxis.title = 'Count';
                    layout.barmode = 'overlay';
                }

                Plotly.newPlot(plotRef.current, traces, layout, { responsive: true });
            }, [realData, synthData, activeTab]);

            const handleTrain = () => {
                const real = generatePopulation(nSamples, trueCorrelation);
                setRealData(real);
                runTraining(real);
            };

            // Calculate metrics
            const metrics = synthData && realData ? {
                trueCorr: correlation(realData.age, realData.capital_gains),
                synthCorr: correlation(synthData.age, synthData.capital_gains),
                coverage: calculateCoverage(realData, synthData, 'wages'),
                rareTypePct: synthData.age.filter(a => a >= 65).length / synthData.age.length
            } : null;

            return (
                <div className="container">
                    <header>
                        <h1>FusionGAN Interactive Demo</h1>
                        <p className="subtitle">Multi-Source Adversarial Synthesis for Survey Data Fusion</p>
                    </header>

                    <div className="main-grid">
                        <div className="controls">
                            <h3 style={{marginBottom: '1.5rem', color: '#00d4ff'}}>Parameters</h3>

                            <div className="control-group">
                                <label>Sample Size: <span className="control-value">{nSamples}</span></label>
                                <input
                                    type="range"
                                    min="100"
                                    max="2000"
                                    step="100"
                                    value={nSamples}
                                    onChange={(e) => setNSamples(parseInt(e.target.value))}
                                />
                            </div>

                            <div className="control-group">
                                <label>Training Epochs: <span className="control-value">{epochs}</span></label>
                                <input
                                    type="range"
                                    min="10"
                                    max="500"
                                    step="10"
                                    value={epochs}
                                    onChange={(e) => setEpochs(parseInt(e.target.value))}
                                />
                            </div>

                            <div className="control-group">
                                <label>True Correlation: <span className="control-value">{trueCorrelation.toFixed(1)}</span></label>
                                <input
                                    type="range"
                                    min="0"
                                    max="1"
                                    step="0.1"
                                    value={trueCorrelation}
                                    onChange={(e) => setTrueCorrelation(parseFloat(e.target.value))}
                                />
                            </div>

                            <div className="control-group">
                                <label>Weighting Strategy</label>
                                <select value={weighting} onChange={(e) => setWeighting(e.target.value)}>
                                    <option value="uniform">Uniform</option>
                                    <option value="cluster">Cluster-based</option>
                                    <option value="density">Density-based</option>
                                </select>
                            </div>

                            <button onClick={handleTrain} disabled={isTraining}>
                                {isTraining ? 'Training...' : 'Train FusionGAN'}
                            </button>

                            <div className="explanation" style={{marginTop: '1.5rem'}}>
                                <strong>How it works:</strong><br/>
                                FusionGAN uses separate discriminators for each data source (CPS, PUF) but a shared generator. This learns cross-source correlations like the relationship between age (CPS) and capital gains (PUF).
                            </div>
                        </div>

                        <div className="visualization">
                            <div className="tabs">
                                <button
                                    className={`tab ${activeTab === 'distributions' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('distributions')}
                                >
                                    Distributions
                                </button>
                                <button
                                    className={`tab ${activeTab === 'correlation' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('correlation')}
                                >
                                    Cross-Source Correlation
                                </button>
                                <button
                                    className={`tab ${activeTab === 'wages' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('wages')}
                                >
                                    Wages
                                </button>
                            </div>

                            <div className="plot-container" ref={plotRef}></div>

                            {metrics && (
                                <div className="metrics">
                                    <div className="metric-card">
                                        <div className="metric-value">
                                            {(metrics.synthCorr / metrics.trueCorr * 100).toFixed(0)}%
                                        </div>
                                        <div className="metric-label">Correlation Recovery</div>
                                    </div>
                                    <div className="metric-card">
                                        <div className="metric-value">
                                            {metrics.coverage.toFixed(2)}
                                        </div>
                                        <div className="metric-label">Coverage (lower = better)</div>
                                    </div>
                                    <div className="metric-card">
                                        <div className="metric-value">
                                            {(metrics.rareTypePct * 100).toFixed(1)}%
                                        </div>
                                        <div className="metric-label">Rare Type (65+)</div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <div style={{marginTop: '2rem'}}>
                        <h3 style={{color: '#00d4ff', marginBottom: '1rem'}}>Architecture</h3>
                        <div className="visualization">
                            <div className="architecture-diagram">
                                <div className="arch-box arch-noise">
                                    z ~ N(0, I)<br/>
                                    <small>Latent Noise</small>
                                </div>
                                <div className="arch-arrow">→</div>
                                <div className="arch-box arch-gen">
                                    Generator<br/>
                                    <small>G(z)</small>
                                </div>
                                <div className="arch-arrow">→</div>
                                <div className="arch-box arch-synth">
                                    Synthetic<br/>
                                    <small>Complete Record</small>
                                </div>
                                <div className="arch-arrow">→</div>
                                <div className="arch-proj">
                                    <div className="arch-box arch-disc-cps">
                                        D_CPS<br/>
                                        <small>age, wages, UI</small>
                                    </div>
                                    <div className="arch-box arch-disc-puf">
                                        D_PUF<br/>
                                        <small>wages, cap_gains</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <footer style={{textAlign: 'center', marginTop: '3rem', color: '#666', fontSize: '0.9rem'}}>
                        <p>
                            <a href="/" style={{color: '#00d4ff'}}>← Back to Paper</a>
                            {' | '}
                            <a href="https://github.com/CosilicoAI/fusiongan" style={{color: '#00d4ff'}}>GitHub</a>
                        </p>
                    </footer>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
